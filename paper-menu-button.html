<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="../iron-behaviors/iron-control-state.html">
<link rel="import" href="../iron-dropdown/iron-dropdown.html">
<link rel="import" href="../paper-styles/default-theme.html">
<link rel="import" href="../paper-styles/shadow.html">

<!--
Material design: [Dropdown buttons](https://www.google.com/design/spec/components/buttons.html#buttons-dropdown-buttons)

`paper-menu-button` allows one to compose a designated "trigger" element with
another element that represents "content", to create a dropdown menu that
displays the "content" when the "trigger" is clicked.

The child element assigned to the `dropdown-trigger` slot will be used as the
"trigger" element. The child element assigned to the `dropdown-content` slot will be
used as the "content" element.

The `paper-menu-button` is sensitive to its content's `iron-select` events. If
the "content" element triggers an `iron-select` event, the `paper-menu-button`
will close automatically.

Example:

    <paper-menu-button>
      <paper-icon-button icon="menu" slot="dropdown-trigger"></paper-icon-button>
      <paper-listbox slot="dropdown-content">
        <paper-item>Share</paper-item>
        <paper-item>Settings</paper-item>
        <paper-item>Help</paper-item>
      </paper-listbox>
    </paper-menu-button>

### Styling

The following custom properties and mixins are also available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--paper-menu-button-dropdown-background` | Background color of the paper-menu-button dropdown | `--primary-background-color`
`--paper-menu-button` | Mixin applied to the paper-menu-button | `{}`
`--paper-menu-button-disabled` | Mixin applied to the paper-menu-button when disabled | `{}`
`--paper-menu-button-dropdown` | Mixin applied to the paper-menu-button dropdown | `{}`
`--paper-menu-button-content` | Mixin applied to the paper-menu-button content | `{}`

@hero hero.svg
@demo demo/index.html
-->

<dom-module id="paper-menu-button">
  <template>
    <style>
      :host {
        display: inline-block;
        position: relative;
        padding: 8px;
        outline: none;

        @apply --paper-menu-button;
      }

      :host([disabled]) {
        cursor: auto;
        color: var(--disabled-text-color);

        @apply --paper-menu-button-disabled;
      }

      #trigger {
        cursor: pointer;
      }

      iron-dropdown {
        border-radius: 2px;
        @apply --shadow-elevation-2dp;
        @apply --paper-menu-button-dropdown;
      }

      .dropdown-content {
        /* Inherits from iron-dropdown, so inverse animation can work as expected. */
        transform-origin: inherit;
        position: relative;
        background-color: var(--paper-menu-button-dropdown-background, var(--primary-background-color));

        @apply --paper-menu-button-content;
      }
      
      .animating,
      .animating > .dropdown-content {
        overflow: hidden;
        will-change: transform;
        contain: content;
        animation-fill-mode: both;
        animation-timing-function: step-end;
      }

      .animating {
        animation-name: expand-animation;
      }

      .animating > .dropdown-content {
        animation-name: expand-animationInverse;
      }

      .entry-animation,
      .entry-animation > .dropdown-content {
        animation-delay: 100ms;
        animation-duration: 275ms;
      }

      .exit-animation,
      .exit-animation > .dropdown-content {
        animation-duration: 200ms;
        animation-direction: reverse;
      }

      @keyframes expand-animation {
        0% {
          opacity: 0;
          transform: scale(0.7, 0.5);
        }
        6.25% {
          opacity: 0.09;
          transform: scale(0.75669, 0.59448);
        }
        12.5% {
          opacity: 0.17;
          transform: scale(0.80741, 0.67902);
        }
        18.75% {
          opacity: 0.27;
          transform: scale(0.85146, 0.75243);
        }
        25% {
          opacity: 0.36;
          transform: scale(0.88846, 0.8141);
        }
        31.25% {
          opacity: 0.25;
          transform: scale(0.91851, 0.86418);
        }
        37.5% {
          opacity: 0.5;
          transform: scale(0.9421, 0.90351);
        }
        43.75% {
          opacity: 0.58;
          transform: scale(0.96006, 0.93343);
        }
        50% {
          opacity: 0.67;
          transform: scale(0.97333, 0.95555);
        }
        56.25% {
          opacity: 0.75;
          transform: scale(0.98285, 0.97142);
        }
        62.5% {
          opacity: 0.83;
          transform: scale(0.98949, 0.98248);
        }
        68.75% {
          opacity: 0.82;
          transform: scale(0.99395, 0.98992);
        }
        75% {
          opacity: 1;
          transform: scale(0.99682, 0.9947);
        }
        81.25% {
          transform: scale(0.99854, 0.99757);
        }
        87.5% {
          transform: scale(0.99948, 0.99913);
        }
        93.75% {
          transform: scale(0.9999, 0.99983);
        }
        100% {
          transform: scale(1, 1);
        }
      }

      @keyframes expand-animationInverse {
        0% {
          transform: scale(1.42857, 2);
        }
        6.25% {
          transform: scale(1.32155, 1.68214);
        }
        12.5% {
          transform: scale(1.23853, 1.47271);
        }
        18.75% {
          transform: scale(1.17445, 1.32903);
        }
        25% {
          transform: scale(1.12554, 1.22835);
        }
        31.25% {
          transform: scale(1.08872, 1.15717);
        }
        37.5% {
          transform: scale(1.06146, 1.10679);
        }
        43.75% {
          transform: scale(1.0416, 1.07132);
        }
        50% {
          transform: scale(1.0274, 1.04652);
        }
        56.25% {
          transform: scale(1.01745, 1.02942);
        }
        62.5% {
          transform: scale(1.01062, 1.01783);
        }
        68.75% {
          transform: scale(1.00609, 1.01018);
        }
        75% {
          transform: scale(1.00319, 1.00533);
        }
        81.25% {
          transform: scale(1.00146, 1.00244);
        }
        87.5% {
          transform: scale(1.00052, 1.00087);
        }
        93.75% {
          transform: scale(1.0001, 1.00017);
        }
        100% {
          transform: scale(1, 1);
        }
      }
    </style>

    <div id="trigger" on-tap="toggle">
      <slot name="dropdown-trigger"></slot>
    </div>

    <iron-dropdown
      id="dropdown"
      opened="{{opened}}"
      horizontal-align="[[horizontalAlign]]"
      vertical-align="[[verticalAlign]]"
      dynamic-align="[[dynamicAlign]]"
      horizontal-offset="[[horizontalOffset]]"
      vertical-offset="[[verticalOffset]]"
      no-overlap="[[noOverlap]]"
      entry-animation="entry-animation"
      exit-animation="exit-animation"
      no-animations="[[noAnimations]]"
      focus-target="[[_dropdownContent]]"
      allow-outside-scroll="[[allowOutsideScroll]]"
      restore-focus-on-close="[[restoreFocusOnClose]]"
      on-iron-overlay-canceled="__onIronOverlayCanceled">
      <div slot="dropdown-content" class="dropdown-content">
        <slot id="content" name="dropdown-content"></slot>
      </div>
    </iron-dropdown>
  </template>

  <script>
    (function() {
      'use strict';

      var config = {
        ANIMATION_CUBIC_BEZIER: 'cubic-bezier(.3,.95,.5,1)',
        MAX_ANIMATION_TIME_MS: 400
      };

      var PaperMenuButton = Polymer({
        is: 'paper-menu-button',

        /**
         * Fired when the dropdown opens.
         *
         * @event paper-dropdown-open
         */

        /**
         * Fired when the dropdown closes.
         *
         * @event paper-dropdown-close
         */

        behaviors: [
          Polymer.IronA11yKeysBehavior,
          Polymer.IronControlState
        ],

        properties: {
          /**
           * True if the content is currently displayed.
           */
          opened: {
            type: Boolean,
            value: false,
            notify: true,
            observer: '_openedChanged'
          },

          /**
           * The orientation against which to align the menu dropdown
           * horizontally relative to the dropdown trigger.
           */
          horizontalAlign: {
            type: String,
            value: 'left',
            reflectToAttribute: true
          },

          /**
           * The orientation against which to align the menu dropdown
           * vertically relative to the dropdown trigger.
           */
          verticalAlign: {
            type: String,
            value: 'top',
            reflectToAttribute: true
          },

          /**
           * If true, the `horizontalAlign` and `verticalAlign` properties will
           * be considered preferences instead of strict requirements when
           * positioning the dropdown and may be changed if doing so reduces
           * the area of the dropdown falling outside of `fitInto`.
           */
          dynamicAlign: {
            type: Boolean
          },

          /**
           * A pixel value that will be added to the position calculated for the
           * given `horizontalAlign`. Use a negative value to offset to the
           * left, or a positive value to offset to the right.
           */
          horizontalOffset: {
            type: Number,
            value: 0,
            notify: true
          },

          /**
           * A pixel value that will be added to the position calculated for the
           * given `verticalAlign`. Use a negative value to offset towards the
           * top, or a positive value to offset towards the bottom.
           */
          verticalOffset: {
            type: Number,
            value: 0,
            notify: true
          },

          /**
           * If true, the dropdown will be positioned so that it doesn't overlap
           * the button.
           */
          noOverlap: {
            type: Boolean
          },

          /**
           * Set to true to disable animations when opening and closing the
           * dropdown.
           */
          noAnimations: {
            type: Boolean,
            value: false
          },

          /**
           * Set to true to disable automatically closing the dropdown after
           * a selection has been made.
           */
          ignoreSelect: {
            type: Boolean,
            value: false
          },

          /**
           * Set to true to enable automatically closing the dropdown after an
           * item has been activated, even if the selection did not change.
           */
          closeOnActivate: {
            type: Boolean,
            value: false
          },

          /**
           * Deprecated, setting it won't have effects on the animation.
           * `iron-dropdown` doesn't depend anymore on `neon-animation`, and this property is kept
           * here to not break bindings.
           * @deprecated
           */
          openAnimationConfig: {
            type: Object,
            value: function() {
              var defaultValue = [{
                name: 'fade-in-animation',
                timing: {
                  delay: 100,
                  duration: 200
                }
              }, {
                name: 'paper-menu-grow-width-animation',
                timing: {
                  delay: 100,
                  duration: 150,
                  easing: config.ANIMATION_CUBIC_BEZIER
                }
              }, {
                name: 'paper-menu-grow-height-animation',
                timing: {
                  delay: 100,
                  duration: 275,
                  easing: config.ANIMATION_CUBIC_BEZIER
                }
              }];
              // HACK: Mark it so we know if to warn or not on ready.
              defaultValue.__default = true;
              return defaultValue;
            }
          },

          /**
           * Deprecated, setting it won't have effects on the animation.
           * `iron-dropdown` doesn't depend anymore on `neon-animation`, and this property is kept
           * here to not break bindings.
           * @deprecated
           */
          closeAnimationConfig: {
            type: Object,
            value: function() {
              var defaultValue = [{
                name: 'fade-out-animation',
                timing: {
                  duration: 150
                }
              }, {
                name: 'paper-menu-shrink-width-animation',
                timing: {
                  delay: 100,
                  duration: 50,
                  easing: config.ANIMATION_CUBIC_BEZIER
                }
              }, {
                name: 'paper-menu-shrink-height-animation',
                timing: {
                  duration: 200,
                  easing: 'ease-in'
                }
              }];
              // HACK: Mark it so we know if to warn or not on ready.
              defaultValue.__default = true;
              return defaultValue;
            }
          },

          /**
           * By default, the dropdown will constrain scrolling on the page
           * to itself when opened.
           * Set to true in order to prevent scroll from being constrained
           * to the dropdown when it opens.
           */
          allowOutsideScroll: {
            type: Boolean,
            value: false
          },

          /**
           * Whether focus should be restored to the button when the menu closes.
           */
          restoreFocusOnClose: {
            type: Boolean,
            value: true
          },

          /**
           * This is the element intended to be bound as the focus target
           * for the `iron-dropdown` contained by `paper-menu-button`.
           * @private
           */
          _dropdownContent: {
            type: Object
          }
        },

        hostAttributes: {
          role: 'group',
          'aria-haspopup': 'true'
        },

        listeners: {
          'iron-activate': '_onIronActivate',
          'iron-select': '_onIronSelect'
        },

        /**
         * The content element that is contained by the menu button, if any.
         */
        get contentElement() {
          // Polymer 2.x returns slot.assignedNodes which can contain text nodes.
          var nodes = Polymer.dom(this.$.content).getDistributedNodes();
          for (var i = 0, l = nodes.length; i < l; i++) {
            if (nodes[i].nodeType === Node.ELEMENT_NODE) {
              return nodes[i];
            }
          }
        },

        ready: function() {
          if ((this.openAnimationConfig && !this.openAnimationConfig.__default) ||
              (this.closeAnimationConfig && !this.closeAnimationConfig.__default)) {
            console.warn('Configuring animations through openAnimationConfig ' +
              'or closeAnimationConfig is no longer supported.');
          }
        },

        /**
         * Toggles the drowpdown content between opened and closed.
         */
        toggle: function() {
          if (this.opened) {
            this.close();
          } else {
            this.open();
          }
        },

        /**
         * Make the dropdown content appear as an overlay positioned relative
         * to the dropdown trigger.
         */
        open: function() {
          if (this.disabled) {
            return;
          }

          this.$.dropdown.open();
        },

        /**
         * Hide the dropdown content.
         */
        close: function() {
          this.$.dropdown.close();
        },

        /**
         * When an `iron-select` event is received, the dropdown should
         * automatically close on the assumption that a value has been chosen.
         *
         * @param {CustomEvent} event A CustomEvent instance with type
         * set to `"iron-select"`.
         * @private
         */
        _onIronSelect: function(event) {
          if (!this.ignoreSelect) {
            this.close();
          }
        },

        /**
         * Closes the dropdown when an `iron-activate` event is received if
         * `closeOnActivate` is true.
         *
         * @param {CustomEvent} event A CustomEvent of type 'iron-activate'.
         * @private
         */
        _onIronActivate: function(event) {
          if (this.closeOnActivate) {
            this.close();
          }
        },

        /**
         * When the dropdown opens, the `paper-menu-button` fires `paper-open`.
         * When the dropdown closes, the `paper-menu-button` fires `paper-close`.
         *
         * @param {boolean} opened True if the dropdown is opened, otherwise false.
         * @param {boolean} oldOpened The previous value of `opened`.
         * @private
         */
        _openedChanged: function(opened, oldOpened) {
          if (opened) {
            // TODO(cdata): Update this when we can measure changes in distributed
            // children in an idiomatic way.
            // We poke this property in case the element has changed. This will
            // cause the focus target for the `iron-dropdown` to be updated as
            // necessary:
            this._dropdownContent = this.contentElement;
            this.fire('paper-dropdown-open');
          } else if (oldOpened != null) {
            this.fire('paper-dropdown-close');
          }
        },

        /**
         * If the dropdown is open when disabled becomes true, close the
         * dropdown.
         *
         * @param {boolean} disabled True if disabled, otherwise false.
         * @private
         */
        _disabledChanged: function(disabled) {
          Polymer.IronControlState._disabledChanged.apply(this, arguments);
          if (disabled && this.opened) {
            this.close();
          }
        },

        /**
         * @private
         */
        __onIronOverlayCanceled: function(event) {
          var uiEvent = event.detail;
          var target = Polymer.dom(uiEvent).rootTarget;
          var trigger = this.$.trigger;
          var path = Polymer.dom(uiEvent).path;

          if (path.indexOf(trigger) > -1) {
            event.preventDefault();
          }
        }
      });

      Object.keys(config).forEach(function (key) {
        PaperMenuButton[key] = config[key];
      });

      Polymer.PaperMenuButton = PaperMenuButton;
    })();
  </script>
</dom-module>
